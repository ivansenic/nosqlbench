# nb -v run driver=http yaml=http-docsapi-keyvalue tags=phase:schema stargate_host=my_stargate_host auth_token=$AUTH_TOKEN

description: |
  This workload emulates a key-value data model and access patterns.
  This should be identical to the cql variant except for:
  - Schema creation with the Docs API, we don't use cql because the Docs API is opinionated about schema.
  - There is no instrumentation with the http driver.
  - There is no async mode with the http driver.
  Note that stargate_port should reflect the port where the Docs API is exposed (defaults to 8082). 

scenarios:
  default:
    schema: run driver=http tags==phase:schema threads==1 cycles==UNDEF
    rampup: run driver=http tags==phase:rampup cycles===TEMPLATE(rampup-cycles,10000000) threads=auto
    search: run driver=http tags==phase:main cycles===TEMPLATE(main-cycles,10000000) threads=auto
bindings:
  # To enable an optional weighted set of hosts in place of a load balancer
  # Examples
  #   single host: stargate_host=host1
  #   multiple hosts: stargate_host=host1,host2,host3
  #   multiple weighted hosts: stargate_host=host1:3,host2:7
  weighted_hosts: WeightedStrings('<<stargate_host:stargate>>')
  # http request id
  request_id: ToHashedUUID(); ToString();

  seq_key: Mod(<<keycount:10000000>>); ToString() -> String
  seq_value: Hash(); Mod(<<valuecount:10000000>>); ToString() -> String
  price: Uniform(0,500) -> double; ToString() -> String
  discount: Hash(); Uniform(0,100) -> double; ToString() -> String
  price_search: FixedValue(500) -> long; Mul(<<candidates_pct:0.05>>) -> double; ToString() -> String
  discount_search: FixedValue(100) -> long; Mul(<<filter_pct:0.1>>) -> double; ToString() -> String

blocks:
  - tags:
      phase: schema
    statements:
      - create-keyspace: POST <<protocol:http>>://{weighted_hosts}:<<stargate_port:8082>><<path_prefix:>>/v2/schemas/keyspaces
        Accept: "application/json"
        X-Cassandra-Request-Id: "{request_id}"
        X-Cassandra-Token: "<<auth_token:my_auth_token>>"
        Content-Type: "application/json"
        body: |
          {
              "name": "<<keyspace:docs_search>>",
              "replicas": <<rf:1>>
          }
        tags:
          name: create-keyspace
      - delete-docs-collection : DELETE <<protocol:http>>://{weighted_hosts}:<<stargate_port:8082>><<path_prefix:>>/v2/namespaces/<<keyspace:docs_search>>/collections/<<table:docs_collection>>
        Accept: "application/json"
        X-Cassandra-Request-Id: "{request_id}"
        X-Cassandra-Token: "<<auth_token:my_auth_token>>"
        tags:
          name: delete-table
        ok-status: "[2-4][0-9][0-9]"
      - create-docs-collection : POST <<protocol:http>>://{weighted_hosts}:<<stargate_port:8082>><<path_prefix:>>/v2/namespaces/<<keyspace:docs_search>>/collections
        Accept: "application/json"
        X-Cassandra-Request-Id: "{request_id}"
        X-Cassandra-Token: "<<auth_token:my_auth_token>>"
        Content-Type: "application/json"
        body: |
          {
              "name": "<<table:docs_collection>>"
          }
        tags:
          name: create-table

  - name: rampup
    tags:
      phase: rampup
    statements:
      - rampup-insert: PUT <<protocol:http>>://{weighted_hosts}:<<stargate_port:8082>><<path_prefix:>>/v2/namespaces/<<keyspace:docs_search>>/collections/<<table:docs_collection>>/{seq_key}
        Accept: "application/json"
        X-Cassandra-Request-Id: "{request_id}"
        X-Cassandra-Token: "<<auth_token:my_auth_token>>"
        Content-Type: "application/json"
        body: |
            {
              "{seq_key}":"{seq_value}",
              "name":"Samsung TV",
              "price":{price},
              "discount":{discount},
              "currency":"USD",
              "tags":[
                "electronics",
                "tv",
                "samsung"
              ],
              "categories":[
                {
                    "id":"c1",
                    "name":"Electronics"
                },
                {
                    "id":"c2",
                    "name":"Sale"
                }
              ],
              "reviews":{
                "r1":{
                    "status":"APPROVED",
                    "rating":4.5,
                    "text":"",
                    "user":{
                      "id":"u1",
                      "fullName":"Ivan Senic"
                    }
                },
                "r2":{
                    "status":"PENDING",
                    "rating":2,
                    "text":"Don't buy",
                    "user":{
                      "id":"u2",
                      "fullName":"Dmitri B."
                    }
                }
              }
            }
        tags:
          name: rampup-insert

  - name: main-search
    tags:
      phase: main
      type: search
    statements:
      - main-select: GET <<protocol:http>>://{weighted_hosts}:<<stargate_port:8082>><<path_prefix:>>/v2/namespaces/<<keyspace:docs_search>>/collections/<<table:docs_collection>>?where=%7B%22price%22%3A%7B%22%24lt%22%3A{price_search}%7D%2C%22discount%22%3A%7B%22%24lt%22%3A{discount_search}%7D%7D%20
        Accept: "application/json"
        X-Cassandra-Request-Id: "{request_id}"
        X-Cassandra-Token: "<<auth_token:my_auth_token>>"
        tags:
          name: main-search
